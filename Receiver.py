import json
from difflib import get_close_matches

# 1. ูุงููุณ Across MENA ูููุฑุงุฏูุงุช (ุงูุนุงูู <-> ุงูุฑุณูู)
SYRIAN_SYNONYMS = {
    "ุฏูุงููุจ": "ุฅุทุงุฑุงุช ูุทุงุทูุฉ",
    "ููุจุฑูุณุฉ": "ุถุงุบุท ููุงุก",
    "ููุชูุฑุงุช": "ูุญุฑู ุงุญุชุฑุงู ุฏุงุฎูู",
    "ุฌูุทุงุช": "ุฅุทุงุฑุงุช ูุนุฏููุฉ",
    "ูุจุฑูุด": "ุฃูุงุจูุจ ูุฎุฑุงุทูู",
    "ุณูููู": "ุฃูุงุจูุจ ูุฎุฑุงุทูู",
    "ูุฏุงุช": "ุตูุงูุงุช ุซูุงุฆูุฉ ุจุงุนุซุฉ ููุถูุก",
    "ุจุฑูุฌูุชูุฑุงุช": "ุตูุงูุงุช ุซูุงุฆูุฉ ุจุงุนุซุฉ ููุถูุก",
    "ุจุทุงุฑูุงุช ุฌูู": "ูุฏุฎุฑุงุช ููุฑุจุงุฆูุฉ",
    "ุทุงูุฉ ุดูุณูุฉ": "ูุฏุฎุฑุงุช ููุฑุจุงุฆูุฉ",
    "ุฑุงูุชุฑ": "ุฃุฌูุฒุฉ ุฅุฑุณุงู ูุงุณุชูุจุงู ุจูุงูุงุช",
    "ูุงูู": "ุฃุฌูุฒุฉ ุฅุฑุณุงู ูุงุณุชูุจุงู ุจูุงูุงุช",
    "ุดููุงุฌุงุช": "ูุดุนุงุช ุชุฏูุฆุฉ",
    "ููููุงุช": "ุฃุฌูุฒุฉ ุชูููู ููุงุก",
    "ุตุงุฌ": "ููุชุฌุงุช ูุฏุฑููุฉ ูู ูููุงุฐ",
    "ุนุฏุฉ ุตูุงุนูุฉ": "ุฃุฏูุงุช ูุฏููุฉ ูู ูุนุงุฏู",
    "ุฎุฑุฏูุงุช": "ุฃุฏูุงุช ูุฏููุฉ ูู ูุนุงุฏู",
    "ุฃูุจุณุฉ ุจุงูุงุช": "ุฃูุจุณุฉ ูุณุชุนููุฉ",
    "ุจุฑุงุฏุงุช": "ุซูุงุฌุงุช ููุฌูุฏุงุช",
    "ุบุณุงูุงุช": "ุขูุงุช ุบุณู ุฃูุจุณุฉ",
    "ููุงุด": "ููุณูุฌุงุช",
    "ุณูุฑุงููู": "ุจูุงุท ูุตูุงุนุงุช ุฎุฒููุฉ",
    "ูุฏุงุญุฉ": "ููุงุนุฉ ุฌูุจ"
}

def clean_input(user_query):
    """ุชูุธูู ุงููุต ูุชุจุฏูู ุงููููุงุช ุงูุนุงููุฉ"""
    query = user_query.strip().lower()
    words = query.split()
    # ุงุณุชุจุฏุงู ุงููููุงุช ุฅุฐุง ูุฌุฏุช ูู ุงููุงููุณุ ูุฅูุง ุงูุญูุงุธ ุนูู ุงููููุฉ ุงูุฃุตููุฉ
    translated_words = [SYRIAN_SYNONYMS.get(w, w) for w in words]
    return " ".join(translated_words)

def find_best_match(query, database_path="knowledge_base.json"):
    """ุงูุจุญุซ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุนู ุฃูุถู ุชุทุงุจู"""
    try:
        with open(database_path, 'r', encoding='utf-8') as f:
            data = json.load(f)
            
        # ูุงุฆูุฉ ุงูููุงุฏ ูู ููู ุงูู JSON ุงูุฎุงุต ุจู
        materials_list = [item['material_clean'] for item in data]
        
        # ุงูุจุญุซ ุนู ุฃูุฑุจ ุชุทุงุจู (ูุธุงู ุงูุจุญุซ ุงููุฑู)
        # cutoff=0.3 ุชุนูู ูุจูู ุชุดุงุจู ุจุณูุท ูุชุบุทูุฉ ุฃูุจุฑ ูุฏุฑ ูู ุงูุงุญุชูุงูุงุช
        matches = get_close_matches(query, materials_list, n=1, cutoff=0.3)
        
        if matches:
            result = next(item for item in data if item['material_clean'] == matches[0])
            return result
        return None
    except FileNotFoundError:
        return "ุฎุทุฃ: ููู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุบูุฑ ููุฌูุฏ."
    except Exception as e:
        return f"ุฎุทุฃ ุบูุฑ ูุชููุน: {e}"

# --- ุชุฌุฑุจุฉ ุงูุชุดุบูู ููุงุฎุชุจุงุฑ ---
if __name__ == "__main__":
    test_query = "ุจุฏู ุงุณุชูุฑุฏ ููุจุฑูุณุฉ"
    processed = clean_input(test_query)
    match = find_best_match(processed)
    
    if match:
        print(f"โ ุชู ุงูุชุนุฑู ุนูู ุงูููุชุฌ: {match['material_clean']}")
        print(f"๐ข ุงูุจูุฏ ุงูุฌูุฑูู: {match['hs6_global']}")
    else:
        print("โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุชุทุงุจู ุฏููู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช.")
